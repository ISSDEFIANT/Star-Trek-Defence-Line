using UnityEngine;
using System.Collections;
using System.Collections.Generic;
using System.Xml.Linq;
using System.IO;

public class SameGameSystem : MonoBehaviour {
	public List<ObjectDataToSave> SaveObjects;
	public string SaveName;
	//public GameMenu _GM;
	// Use this for initialization
	void Start () {
		if (GlobalLoadSystem.load) {
			Load ();
			GlobalLoadSystem.load = false;
		}
	}
	
	// Update is called once per frame
	private void Update () {
		//Просто кнопки для сохранения и загрузки.
		//if (Input.GetKeyDown (KeyCode.S)) {
		//	Save();
		//}
		//if (Input.GetKeyDown (KeyCode.L)) {
		//	Load();
		//}


	}
	void Awake(){
		//_GM = GameObject.FindGameObjectWithTag ("MainUI").GetComponent<GameMenu> ();
	}

	public void Save(){
		//Сдесь собирается документ. Все данные из листа SaveObjects. В него вносятся все элементы ObjectDataToSave (Они сами себя туда заносят).
		XElement root = new XElement ("root");

		foreach (var saveObj in SaveObjects) {
			root.Add (saveObj.GetElement ());
		}
		root.Add (GameObject.FindGameObjectWithTag ("MainUI").GetComponent<GameDataSaver> ().GetElement());
		XDocument saveDoc = new XDocument (root);
		//Строчка создаёт файл. Тут же находится путь.
		File.WriteAllText ("Data/Saves/" + SaveName + ".xml", saveDoc.ToString ());
	}
	public void Load(){
		//Загрузка документа.
		XElement root = null;

		if (!File.Exists ("Data/Saves/" + GameMenu.LoadName)) {
		} else {
			root = XDocument.Parse (File.ReadAllText ("Data/Saves/" + GameMenu.LoadName)).Element ("root");
		}
		//Выставление элементов на сцену.
		GenerateScene (root);
	}
	private void GenerateScene(XElement root){
		//Удаление уже имеющихся объектов, что бы предотвратить дублирование.
		foreach (ObjectDataToSave obj in SaveObjects) {
			Destroy (obj.gameObject);
		}
		//Вызов внутреннего элемента документа.
		foreach (XElement instance in root.Elements("instance")) {
			Vector3 position = Vector3.zero;
			//Загрузка расположение.
			position.x = float.Parse (instance.Attribute ("X").Value);
			position.y = float.Parse (instance.Attribute ("Y").Value);
			position.z = float.Parse (instance.Attribute ("Z").Value);

			Vector3 rotation = Vector3.zero;
			//Загрузка поворота.
			rotation.x = float.Parse (instance.Attribute ("Rx").Value);
			rotation.y = float.Parse (instance.Attribute ("Ry").Value);
			rotation.z = float.Parse (instance.Attribute ("Rz").Value);
			//Создание объекттов. Все загружаемые объекты должны быть в папке Resources.
			GameObject go = Instantiate (Resources.Load<GameObject> (instance.Value), position, Quaternion.identity) as GameObject;
			Quaternion GoRotation = Quaternion.Euler (float.Parse (instance.Attribute ("Rx").Value), float.Parse (instance.Attribute ("Ry").Value), float.Parse (instance.Attribute ("Rz").Value));
			//Присвоение поворота.
			go.GetComponent<ObjectDataToSave> ().SetCapNum = int.Parse(instance.Attribute ("CapNum").Value);
			go.GetComponent<ObjectDataToSave> ().SetRace = instance.Attribute ("Race").Value;
			go.GetComponent<ObjectDataToSave> ().SetFixID = float.Parse (instance.Attribute ("FixID").Value);

			go.GetComponent<ObjectDataToSave> ().SBuildCurTime = float.Parse(instance.Attribute ("BuildCurTime").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildShipsCount = int.Parse (instance.Attribute ("BuildShipCount").Value);

			go.GetComponent<ObjectDataToSave> ().SBuildTime1 = float.Parse(instance.Attribute ("BuildTime1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildClass1 = instance.Attribute ("BuildClass1").Value;
			go.GetComponent<ObjectDataToSave> ().SBuildNumper1 = int.Parse (instance.Attribute ("BuildNumper1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildTitanium1 = float.Parse(instance.Attribute ("BuildTitanium1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildDilithium1 = float.Parse(instance.Attribute ("BuildDilithium1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildHumans1 = float.Parse(instance.Attribute ("BuildHumans1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBuilder1 = bool.Parse(instance.Attribute ("BuildBuilder1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildMiner1 = bool.Parse(instance.Attribute ("BuildMiner1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBaseFleet1 = bool.Parse (instance.Attribute ("BuildBaseFleet1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildAttackFleet1 = bool.Parse(instance.Attribute ("BuildAttackFleet1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildScoutFleet1 = bool.Parse(instance.Attribute ("BuildScoutFleet1").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildOpenTime1 = float.Parse(instance.Attribute ("BuildOpenTime1").Value);

			go.GetComponent<ObjectDataToSave> ().SBuildTime2 = float.Parse(instance.Attribute ("BuildTime2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildClass2 = instance.Attribute ("BuildClass2").Value;
			go.GetComponent<ObjectDataToSave> ().SBuildNumper2 = int.Parse (instance.Attribute ("BuildNumper2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildTitanium2 = float.Parse(instance.Attribute ("BuildTitanium2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildDilithium2 = float.Parse(instance.Attribute ("BuildDilithium2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildHumans2 = float.Parse(instance.Attribute ("BuildHumans2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBuilder2 = bool.Parse(instance.Attribute ("BuildBuilder2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildMiner2 = bool.Parse(instance.Attribute ("BuildMiner2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBaseFleet2 = bool.Parse (instance.Attribute ("BuildBaseFleet2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildAttackFleet2 = bool.Parse(instance.Attribute ("BuildAttackFleet2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildScoutFleet2 = bool.Parse(instance.Attribute ("BuildScoutFleet2").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildOpenTime2 = float.Parse(instance.Attribute ("BuildOpenTime2").Value);

			go.GetComponent<ObjectDataToSave> ().SBuildTime3 = float.Parse(instance.Attribute ("BuildTime3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildClass3 = instance.Attribute ("BuildClass3").Value;
			go.GetComponent<ObjectDataToSave> ().SBuildNumper3 = int.Parse (instance.Attribute ("BuildNumper3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildTitanium3 = float.Parse(instance.Attribute ("BuildTitanium3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildDilithium3 = float.Parse(instance.Attribute ("BuildDilithium3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildHumans3 = float.Parse(instance.Attribute ("BuildHumans3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBuilder3 = bool.Parse(instance.Attribute ("BuildBuilder3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildMiner3 = bool.Parse(instance.Attribute ("BuildMiner3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBaseFleet3 = bool.Parse (instance.Attribute ("BuildBaseFleet3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildAttackFleet3 = bool.Parse(instance.Attribute ("BuildAttackFleet3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildScoutFleet3 = bool.Parse(instance.Attribute ("BuildScoutFleet3").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildOpenTime3 = float.Parse(instance.Attribute ("BuildOpenTime3").Value);

			go.GetComponent<ObjectDataToSave> ().SBuildTime4 = float.Parse(instance.Attribute ("BuildTime4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildClass4 = instance.Attribute ("BuildClass4").Value;
			go.GetComponent<ObjectDataToSave> ().SBuildNumper4 = int.Parse (instance.Attribute ("BuildNumper4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildTitanium4 = float.Parse(instance.Attribute ("BuildTitanium4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildDilithium4 = float.Parse(instance.Attribute ("BuildDilithium4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildHumans4 = float.Parse(instance.Attribute ("BuildHumans4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBuilder4 = bool.Parse(instance.Attribute ("BuildBuilder4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildMiner4 = bool.Parse(instance.Attribute ("BuildMiner4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBaseFleet4 = bool.Parse (instance.Attribute ("BuildBaseFleet4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildAttackFleet4 = bool.Parse(instance.Attribute ("BuildAttackFleet4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildScoutFleet4 = bool.Parse(instance.Attribute ("BuildScoutFleet4").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildOpenTime4 = float.Parse(instance.Attribute ("BuildOpenTime4").Value);

			go.GetComponent<ObjectDataToSave> ().SBuildTime5 = float.Parse(instance.Attribute ("BuildTime5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildClass5 = instance.Attribute ("BuildClass5").Value;
			go.GetComponent<ObjectDataToSave> ().SBuildNumper5 = int.Parse (instance.Attribute ("BuildNumper5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildTitanium5 = float.Parse(instance.Attribute ("BuildTitanium5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildDilithium5 = float.Parse(instance.Attribute ("BuildDilithium5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildHumans5 = float.Parse(instance.Attribute ("BuildHumans5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBuilder5 = bool.Parse(instance.Attribute ("BuildBuilder5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildMiner5 = bool.Parse(instance.Attribute ("BuildMiner5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildBaseFleet5 = bool.Parse (instance.Attribute ("BuildBaseFleet5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildAttackFleet5 = bool.Parse(instance.Attribute ("BuildAttackFleet5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildScoutFleet5 = bool.Parse(instance.Attribute ("BuildScoutFleet5").Value);
			go.GetComponent<ObjectDataToSave> ().SBuildOpenTime5 = float.Parse(instance.Attribute ("BuildOpenTime5").Value);

			go.gameObject.transform.rotation = GoRotation;
			//Присвоение переменных. Каждый получит свои элементы, и путаницы не будет.
			go.gameObject.GetComponent<ObjectDataToSave> ().GetHeath = float.Parse (instance.Attribute ("health").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetShild = float.Parse (instance.Attribute ("shild").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetEnergy = float.Parse (instance.Attribute ("energy").Value);

			go.gameObject.GetComponent<ObjectDataToSave> ().GetCrew = float.Parse (instance.Attribute ("crew").Value);

			go.gameObject.GetComponent<ObjectDataToSave> ().GetImpulse = float.Parse (instance.Attribute ("ImpulseSystemHealth").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetLifeSupport = float.Parse (instance.Attribute ("LifeSupportSystemHealth").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetPrimaryWeapon = float.Parse (instance.Attribute ("PrimaryWeaponSystemHealth").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetSensors = float.Parse (instance.Attribute ("SensorsSystemHealth").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetTractorBeam = float.Parse (instance.Attribute ("TractorBeamSystemHealth").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetWarpEnging = float.Parse (instance.Attribute ("WarpEngingSystemHealth").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetWarpCore = float.Parse (instance.Attribute ("WarpCoreHealth").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().GetSecondaryWeapon = float.Parse (instance.Attribute ("SecondaryWeaponSystemHealth").Value);

			go.gameObject.GetComponent<ObjectDataToSave> ().Get0 = bool.Parse (instance.Attribute ("T0").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get1 = bool.Parse (instance.Attribute ("T1").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get2 = bool.Parse (instance.Attribute ("T2").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get3 = bool.Parse (instance.Attribute ("T3").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get4 = bool.Parse (instance.Attribute ("T4").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get5 = bool.Parse (instance.Attribute ("T5").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get6 = bool.Parse (instance.Attribute ("T6").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get7 = bool.Parse (instance.Attribute ("T7").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get8 = bool.Parse (instance.Attribute ("T8").Value);
			go.gameObject.GetComponent<ObjectDataToSave> ().Get9 = bool.Parse (instance.Attribute ("T9").Value);

			go.GetComponent<ObjectDataToSave>().SetIsMine = bool.Parse (instance.Attribute ("IsMine").Value);
			go.GetComponent<ObjectDataToSave>().SetDilMine = bool.Parse (instance.Attribute ("DilMine").Value);
			go.GetComponent<ObjectDataToSave>().SetTitMine = bool.Parse (instance.Attribute ("TitMine").Value);
			go.GetComponent<ObjectDataToSave>().SetCrewMine = bool.Parse (instance.Attribute ("CrewMine").Value);

			go.GetComponent<ObjectDataToSave>().GetAI = bool.Parse (instance.Attribute ("AI").Value);
			go.GetComponent<ObjectDataToSave>().GetFAI = bool.Parse (instance.Attribute ("FAI").Value);
			go.GetComponent<ObjectDataToSave>().ReadyShip = bool.Parse (instance.Attribute ("RS").Value);
			go.GetComponent<ObjectDataToSave>().GetSSName = instance.Attribute ("SSName").Value;
			go.GetComponent<ObjectDataToSave>().GetAIOwner = GameObject.Find(instance.Attribute ("Owner").Value);

			go.GetComponent<ObjectDataToSave>().SetID = float.Parse(instance.Attribute ("ID").Value);
			go.GetComponent<ObjectDataToSave>().SetTargetID = float.Parse(instance.Attribute ("TargetID").Value);

			go.GetComponent<ObjectDataToSave>().SetAssimilated = bool.Parse (instance.Attribute ("Assimilated").Value);

			go.GetComponent<ObjectDataToSave>().SetLevel = int.Parse (instance.Attribute ("Level").Value);

			go.GetComponent<ObjectDataToSave> ().GetMoveTransform = new Vector3 (float.Parse (instance.Attribute ("MoveX").Value), float.Parse (instance.Attribute ("MoveY").Value), float.Parse (instance.Attribute ("MoveZ").Value));

			go.GetComponent<ObjectDataToSave> ().LoadSomeData ();
		}
		//Загрузка второй части документа с данными уровня, ресурсами, и т.д.
		foreach (XElement instance in root.Elements("instanceGDB")) {
			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().Humans = float.Parse (instance.Attribute ("Crew").Value);
			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().Titanium = float.Parse (instance.Attribute ("Titenium").Value);
			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().Dilithium = float.Parse (instance.Attribute ("Dilithium").Value);

			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().EnemyHumans = float.Parse (instance.Attribute ("EnemyCrew").Value);
			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().EnemyTitanium = float.Parse (instance.Attribute ("EnemyTitenium").Value);
			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().EnemyDilithium = float.Parse (instance.Attribute ("EnemyDilithium").Value);
		
			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().FreandHumans = float.Parse (instance.Attribute ("FreandCrew").Value);
			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().FreandTitanium = float.Parse (instance.Attribute ("FreandTitenium").Value);
			GameObject.FindGameObjectWithTag("MainUI").GetComponent<GlobalDB>().FreandDilithium = float.Parse (instance.Attribute ("FreandDilithium").Value);
		}
	}
}
